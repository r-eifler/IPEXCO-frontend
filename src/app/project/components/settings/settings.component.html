
<div *ngIf="settings">

  <form class="settings-form"
    [formGroup]="form"
    (ngSubmit)="onSave()">

      <mat-card appearance="outlined">
        <mat-card-header>
          <mat-card-title>
            Main
          </mat-card-title>
        </mat-card-header>

        <mat-card-content class="sub-card-content">

          <mat-checkbox [formControl]="form.controls.main.controls.public">public</mat-checkbox>

          <mat-checkbox [formControl]="form.controls.main.controls.usePlanPropertyUtility">use utility</mat-checkbox>

          <mat-form-field class="example-full-width" appearance="outline">
            <mat-label>Maximal number of iteration Steps</mat-label>
            <input matInput type="number" placeholder="100"  [formControl]="form.controls.main.controls.maxRuns">
          </mat-form-field>

        </mat-card-content>
      </mat-card>

      <mat-card appearance="outlined">
        <mat-card-header>
          <mat-card-title>
            Services
          </mat-card-title>
        </mat-card-header>

        <mat-card-content class="sub-card-content">

          <mat-checkbox [formControl]="form.controls.services.controls.computePlanAutomatically">
            automatic plan computation
          </mat-checkbox>

          <mat-checkbox [formControl]="form.controls.services.controls.computeExplanationsAutomatically">
            automatic explanation computation
          </mat-checkbox>

          <mat-form-field appearance="outline" class="full-width">
              <mat-label>Planners</mat-label>
              <mat-select [formControl]="form.controls.services.controls.planners" multiple>
                <option value="" disabled selected></option>
                @for (planner of planners(); track planner._id) {
                  <mat-option [value]="planner._id">{{planner.name}}</mat-option>
                }
              </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Explainers</mat-label>
            <mat-select [formControl]="form.controls.services.controls.explainer" multiple>
              <option value="" disabled selected></option>
              @for (exp of explainer(); track exp._id) {
                <mat-option [value]="exp._id">{{exp.name}}</mat-option>
              }
            </mat-select>
        </mat-form-field>

        </mat-card-content>
      </mat-card>

      <mat-card appearance="outlined">
        <mat-card-header>
          <mat-card-title>
            Interfaces
          </mat-card-title>
        </mat-card-header>

        <mat-card-content class="sub-card-content">

        <mat-label matTooltip="Interface used for creating plan properties.">
            Property Creation Interface
        </mat-label>
        <mat-button-toggle-group  [formControl]="form.controls.interfaces.controls.propertyCreationInterfaceType">
          <mat-button-toggle [value]="PropertyCreationTypes.TEMPLATE_BASED">Templates</mat-button-toggle>
          <mat-button-toggle [value]="PropertyCreationTypes.LLM_CHAT">LLM Chat</mat-button-toggle>
        </mat-button-toggle-group>

        <mat-label matTooltip="Interface used for providing explanations">
          Explanation Interface
        </mat-label>
        <mat-button-toggle-group  [formControl]="form.controls.interfaces.controls.explanationInterfaceType">
          <mat-button-toggle [value]="ExplanationTypes.TEMPLATE_QUESTION_ANSWER">Templates</mat-button-toggle>
          <mat-button-toggle [value]="ExplanationTypes.MUGS_VISUALIZATION">MUGS Visualization</mat-button-toggle>
          <mat-button-toggle [value]="ExplanationTypes.LLM_CHAT">LLM Chat</mat-button-toggle>
        </mat-button-toggle-group>
       

        </mat-card-content>
      </mat-card>

      @if(form.controls.interfaces.controls.explanationInterfaceType.value == ExplanationTypes.LLM_CHAT || 
      form.controls.interfaces.controls.propertyCreationInterfaceType.value == PropertyCreationTypes.LLM_CHAT){
      <mat-card appearance="outlined">
        <mat-card-header>
          <mat-card-title>
            LLM Config
          </mat-card-title>
        </mat-card-header>

        <mat-card-content class="sub-card-content">

          <mat-form-field class="example-full-width" appearance="outline">
            <mat-label>Model</mat-label>
            <input matInput type="text" placeholder="gpt-4o-mini"  [formControl]="form.controls.llmConfig.controls.model">
          </mat-form-field>

          <mat-form-field class="example-full-width" appearance="outline">
            <mat-label>Temperature</mat-label>
            <input matInput type="number" placeholder="0"  [formControl]="form.controls.llmConfig.controls.temperature">
            @if (form.controls.llmConfig.controls.temperature.hasError('min') || form.controls.llmConfig.controls.temperature.hasError('max')) {
              <mat-error>Temperature must between 0 and 2.</mat-error>
            }
          </mat-form-field> 

          <mat-form-field class="example-full-width" appearance="outline">
            <mat-label>Maximal number of completion tokens</mat-label>
            <input matInput type="number"   [formControl]="form.controls.llmConfig.controls.maxCompletionTokens">
          </mat-form-field>

          <mat-label>Prompts</mat-label>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>System Prompt</mat-label>
            <mat-select [formControl]="form.controls.llmConfig.controls.prompts.controls.system">
              <option value="" disabled selected></option>
              @for (prompt of systemPrompts(); track prompt._id) {
                <mat-option [value]="prompt._id">{{prompt.name}}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Goal Translator Instructions Prompt</mat-label>
            <mat-select [formControl]="form.controls.llmConfig.controls.prompts.controls.goalTransInstructions">
              <option value="" disabled selected></option>
              @for (prompt of goalTransInstructionPrompts(); track prompt._id) {
                <mat-option [value]="prompt._id">{{prompt.name}}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Goal Translator Data Prompt</mat-label>
            <mat-select [formControl]="form.controls.llmConfig.controls.prompts.controls.goalTransData">
              <option value="" disabled selected></option>
              @for (prompt of goalTransDataPrompts(); track prompt._id) {
                <mat-option [value]="prompt._id">{{prompt.name}}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Question Classifier Instructions Prompt</mat-label>
            <mat-select [formControl]="form.controls.llmConfig.controls.prompts.controls.questionClassInstructions">
              <option value="" disabled selected></option>
              @for (prompt of questionClassInstructionPrompts(); track prompt._id) {
                <mat-option [value]="prompt._id">{{prompt.name}}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Question Classifier Data Prompt</mat-label>
            <mat-select [formControl]="form.controls.llmConfig.controls.prompts.controls.questionClassData">
              <option value="" disabled selected></option>
              @for (prompt of questionClassDataPrompts(); track prompt._id) {
                <mat-option [value]="prompt._id">{{prompt.name}}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Explanation Translator Instructions Prompt</mat-label>
            <mat-select [formControl]="form.controls.llmConfig.controls.prompts.controls.explanationTransInstruction">
              <option value="" disabled selected></option>
              @for (prompt of explanationTransInstructionPrompts(); track prompt._id) {
                <mat-option [value]="prompt._id">{{prompt.name}}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Explanation Translator Data Prompt</mat-label>
            <mat-select [formControl]="form.controls.llmConfig.controls.prompts.controls.explanationTransData">
              <option value="" disabled selected></option>
              @for (prompt of explanationTransDataPrompts(); track prompt._id) {
                <mat-option [value]="prompt._id">{{prompt.name}}</mat-option>
              }
            </mat-select>
          </mat-form-field>


          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Goal Translator Output Schema</mat-label>
            <mat-select [formControl]="form.controls.llmConfig.controls.outputSchemas.controls.goalTrans">
              <option value="" disabled selected></option>
              @for (schema of goalTransOutputSchemas(); track schema._id) {
                <mat-option [value]="schema._id">{{schema.name}}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Question Classifier Output Schema</mat-label>
            <mat-select [formControl]="form.controls.llmConfig.controls.outputSchemas.controls.questionClass">
              <option value="" disabled selected></option>
              @for (schema of questionClassOutputSchemas(); track schema._id) {
                <mat-option [value]="schema._id">{{schema.name}}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Explanation Translator Output Schema</mat-label>
            <mat-select [formControl]="form.controls.llmConfig.controls.outputSchemas.controls.explanationTrans">
              <option value="" disabled selected></option>
              @for (schema of explanationTransOutputSchemas(); track schema._id) {
                <mat-option [value]="schema._id">{{schema.name}}</mat-option>
              }
            </mat-select>
          </mat-form-field>

        </mat-card-content>
      </mat-card>
      }

      <mat-card appearance="outlined">
        <mat-card-header>
          <mat-card-title>
            User Study
          </mat-card-title>
        </mat-card-header>

        <mat-card-content class="sub-card-content">

          <mat-checkbox [formControl]="form.controls.userStudy.controls.introTask">
            introduction Task
          </mat-checkbox>

          <mat-checkbox [formControl]="form.controls.userStudy.controls.checkMaxUtility">
            Notify user when maximal utility is reached
          </mat-checkbox>

          <mat-checkbox [formControl]="form.controls.userStudy.controls.showPaymentInfo">
            Show information about payment
          </mat-checkbox>

          @if(form.controls.userStudy.controls.showPaymentInfo.value){
            <mat-form-field class="example-full-width" appearance="outline">
              <mat-label>Minimal Payment</mat-label>
              <input matInput type="number"   [formControl]="form.controls.userStudy.controls.paymentInfo.controls.min">
            </mat-form-field>

            <mat-form-field class="example-full-width" appearance="outline">
              <mat-label>Maximal Payment</mat-label>
              <input matInput type="number"   [formControl]="form.controls.userStudy.controls.paymentInfo.controls.max">
            </mat-form-field>

            <mat-form-field class="example-full-width" appearance="outline">
              <mat-label>Steps (semicolon separated list)</mat-label>
              <input matInput type="number"   [formControl]="form.controls.userStudy.controls.paymentInfo.controls.max">
            </mat-form-field>
          }

        </mat-card-content>
      </mat-card>
   

    <div class="button-container">
      <!-- <button mat-flat-button [disabled]="!form.valid">Save</button> -->
      <button mat-flat-button>Save</button>
    </div>
  </form>
</div>
