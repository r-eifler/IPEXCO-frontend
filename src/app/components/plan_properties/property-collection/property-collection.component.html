<div class="main-container">
  <mat-card class="action-card" *ngIf="!modOnlyVisualization">
    <button mat-icon-button color="accent" (click)="new_property_form()">
      <mat-icon>add</mat-icon>
    </button>
    <button mat-icon-button id="prop_download" (click)="download_properties()">
      <mat-icon>download</mat-icon>
    </button>
    <button mat-icon-button (click)="upload_properties()">
      <mat-icon>upload</mat-icon>
    </button>
    <mat-slide-toggle [(ngModel)]="expertView">Expert</mat-slide-toggle>
  </mat-card>

  <mat-card
    *ngIf="!expertView"
    class="basic-card">
    <mat-card-header>
      <mat-card-title>Plan Property Collection</mat-card-title>
    </mat-card-header>
    <mat-card-content class="card-content">
      <table
        mat-table
        id="plan-property-collection-table"
        [dataSource]="dataSource"
        class="property-table"
      >
        <!-- Checkbox Column -->
        <ng-container matColumnDef="select">
          <th mat-header-cell *matHeaderCellDef>used</th>
          <td mat-cell *matCellDef="let prop">
            <mat-checkbox
              (click)="$event.stopPropagation()"
              (change)="$event ? propertyUsedChanged(prop) : null"
              [checked]="prop.isUsed"
            >
            </mat-checkbox>
          </td>
        </ng-container>

        <ng-container matColumnDef="description">
          <th mat-header-cell *matHeaderCellDef>Description</th>
          <td mat-cell *matCellDef="let element" #cellElement>
            <h4 #description (dblclick)="modifyNaturalLanguageDescription(element,description,cellElement)">
              {{ element.naturalLanguageDescription }}
            </h4>
          </td>
        </ng-container>

        <ng-container matColumnDef="globalHardGoal">
          <th mat-header-cell *matHeaderCellDef>Hard Goal</th>
          <td mat-cell *matCellDef="let prop">
            <mat-checkbox
              [disabled]="modOnlyVisualization || !prop.isUsed"
              (click)="$event.stopPropagation()"
              (change)="$event ? propertyGlobalHardGoalChanged(prop) : null"
              [checked]="prop.globalHardGoal">
            </mat-checkbox>
          </td>
        </ng-container>

        <ng-container matColumnDef="value">
          <th mat-header-cell *matHeaderCellDef>Utility</th>
          <td mat-cell *matCellDef="let prop">
            <mat-form-field class="value-form-field">
              <input
                disabled="{{modOnlyVisualization}}"
                matInput
                type="number"
                value="{{ prop.value }}"
                (change)="$event ? propertyValueChanged($event, prop) : null"
                style="width: 50px;"
              />
            </mat-form-field>
          </td>
        </ng-container>

        <ng-container matColumnDef="class">
          <th mat-header-cell *matHeaderCellDef>Class</th>
          <td mat-cell *matCellDef="let element" #cellElement>
            <p *ngIf="modOnlyVisualization" #propCalss>
            {{ element.class }}
            </p>
            <p *ngIf="! modOnlyVisualization" #propCalss (dblclick)="modifyClass(element, propCalss, cellElement)">
              {{ element.class }}
              </p>
          </td>
        </ng-container>

        <ng-container matColumnDef="color">
          <th mat-header-cell *matHeaderCellDef>Color</th>
          <td mat-cell *matCellDef="let prop">
            <div class="color-input">
              <div *ngIf="modOnlyVisualization" class="color-box-nc" [style.background]="prop.color">
              </div>
              <div *ngIf="! modOnlyVisualization" class="color-box"
                [(colorPicker)]="prop.color"
                [style.background]="prop.color"
                [cpOutputFormat] = "'hex'"
                (colorPickerSelect) = "colorChanged($event, prop)">
              </div>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="icon">
          <th mat-header-cell *matHeaderCellDef>Icon</th>
          <td mat-cell *matCellDef="let prop">
              <button mat-icon-button (click)="openIconSelector(prop)" *ngIf="! modOnlyVisualization">
                <mat-icon>{{prop.icon}}</mat-icon>
              </button>
              <mat-icon *ngIf="modOnlyVisualization">{{prop.icon}}</mat-icon>
          </td>
        </ng-container>

        <ng-container matColumnDef="options" *ngIf="!modOnlyVisualization">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let element">
            <button mat-icon-button [matMenuTriggerFor]="menu">
              <mat-icon>more_vert</mat-icon>
            </button>

            <mat-menu #menu="matMenu">
              <button mat-menu-item (click)="openDeleteDialog(element)">
                <mat-icon>delete</mat-icon>
                <span>delete</span>
              </button>
              <button mat-menu-item>
                <mat-icon>file_copy</mat-icon>
                <span>copy</span>
              </button>
              <button mat-menu-item>
                <mat-icon>create</mat-icon>
                <span>modify</span>
              </button>
            </mat-menu>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns">
          <!-- (click)="selection.toggle(row)"> -->
        </tr>
      </table>
    </mat-card-content>
  </mat-card>

  <div *ngIf="expertView" class="expert-view-container">
    <mat-card
      style="justify-content: space-between;"
      *ngFor="let property of planProperties"
      [class.property-card-web]="!isMobile"
      [class.property-card-mobile]="isMobile"
      [class.property-card-not-selected]="!property.isUsed">
      <mat-card-header>
        <div mat-card-avatar>
          <div class="property-icon">
            {{ property.type }}
          </div>
        </div>
        <mat-card-title>{{ property.name }}</mat-card-title>
        <mat-card-subtitle>Property</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <p>{{ property.naturalLanguageDescription }}</p>

        <mat-form-field>
          <mat-label>Utility</mat-label>
          <input
                  disabled="!modOnlyVisualization"
                  matInput
                  type="number"
                  value="{{ property.value }}"
                  (change)="$event ? propertyValueChanged($event, property) : null"
                  style="width: 50px;"
                />
        </mat-form-field>

        <p>Formula: {{ property.formula }}</p>

        <p>Action Sets:</p>
        <mat-accordion>
          <mat-expansion-panel *ngFor="let actionSet of property.actionSets">
            <mat-expansion-panel-header>
              <mat-panel-title>
                {{ actionSet.name }}
              </mat-panel-title>
            </mat-expansion-panel-header>
            <div class="actions-container">
              <mat-list *ngFor="let action of actionSet.actions">
                <mat-list-item>
                  {{ action.name }}({{ action.params}})
                  <mat-divider [inset]="true"></mat-divider>
                </mat-list-item>
              </mat-list>
            </div>
          </mat-expansion-panel>
        </mat-accordion>
      </mat-card-content>
      <mat-card-actions style="justify-content: flex-end; gap: 10px;">
        <button mat-icon-button [matMenuTriggerFor]="menu">
          <mat-icon>more_vert</mat-icon>
        </button>
        <mat-menu #menu="matMenu">
          <button mat-menu-item (click)="openDeleteDialog(property)">
            <mat-icon>delete</mat-icon>
            <span>delete</span>
          </button>
          <button mat-menu-item>
            <mat-icon>file_copy</mat-icon>
            <span>copy</span>
          </button>
          <button mat-menu-item>
            <mat-icon>create</mat-icon>
            <span>modify</span>
          </button>
        </mat-menu>

        <div class="color-input">
          <div class="color-box"
            [(colorPicker)]="property.color"
            [style.background]="property.color"
            [cpOutputFormat] = "'hex'"
            (colorPickerSelect) = "colorChanged($event, property)">
          </div>
        </div>

        <button mat-icon-button (click)="openIconSelector(property)">
          <mat-icon>{{property.icon}}</mat-icon>
        </button>

        <div #propClassContainer class="propClassContainer">
          <p #propCalss (click)="modifyClass(property, propCalss, propClassContainer)">
            {{ property.class }}
          </p>
        </div>

        <mat-slide-toggle
        [checked]="property.isUsed"
        (change)="usePlanProperty($event, property)">
        </mat-slide-toggle>
      </mat-card-actions>
    </mat-card>
  </div>

  
</div>
